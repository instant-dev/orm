# Instant ORM
![npm version](https://img.shields.io/npm/v/@instant.dev/orm?label=) ![Build Status](https://app.travis-ci.com/instant-dev/orm.svg?branch=main)

## JavaScript ORM for Postgres

This is the core ORM package for [**`instant.dev`**](https://github.com/instant-dev/instant).
It is recommended that you use it with the `instant` command line utility
available at [instant-dev/instant](https://github.com/instant-dev/instant) for
easy migration management, **however, it can be used as a standalone ORM**. By
default, upon connecting to a database, the Instant ORM will introspect your
Database schema and determine appropriate models and relationships.

## Getting Started

Installing the Instant ORM:

```shell
npm i @instant.dev/orm
```

Initializing (CommonJS):

```javascript
const InstantORM = require('@instant.dev/orm');
const Instant = new InstantORM();
```

Initializing (ESM):

```javascript
import InstantORM from '@instant.dev/orm';
const Instant = new InstantORM();
```

## Connecting to a Database

By default, the Instant ORM will attempt to load database credentials from
`_instant/db.json[process.env.NODE_ENV]["main"]`. If this file does not exist,
or you want to override these credentials, you can pass in a custom
`databaseConfig` object.

```javascript
await Instant.connect(); // connects based on _instant/db.json

const databaseConfig = {
  host: 'my.postgres.host',
  port: 5432,
  user: 'postgres',
  password: '',
  database: 'postgres',
  ssl: false, // optional: acceptable values are [true, false, "unauthorized"]
  in_vpc: false // optional: if false, will use provided SSH tunnel when deployed
  tunnel: { // optional: use this if we need to SSH tunnel into database
    host: 'my.ssh.host.com',
    port: 22,
    user: 'ec2-user',
    private_key: 'path/to/private_key.pem'
  }
};
await Instant.connect(databaseConfig); // now connected to custom Database
```

## Loading a Schema

When you connect to a database, Instant ORM will attempt to determine the
schema of your database in a few ways.

- First, it will check to see if `_instant/cache/schema.json` exists
  - If it does, it will load the schema from this file
- Next, it will check to see if an `_instant_migrations` table exists in your
  database
  - This table holds all migrations applied to the database and is generated by
    the [instant.dev](https://github.com/instant-dev/instant) CLI automatically
  - If it does exist and has entries, it will load the schema from the latest
    migration
- Finally, it will introspect your database structure
  - All tables, columns, sequences and constraints will be inspected
  - Foreign keys and uniqueness will be used to determine one-to-one and
    one-to-many relationships

## Loading Custom Model Logic

By default, the Instant ORM will load models from the `_instant/models`
directory.
**You do not need a model file for every, or even any, table in your database**.
These are only meant to extend models in the case you want to add Lifecycle
callbacks, validations, verifications, calculated fields or hide data.
Each file should look something like this;

File: `_instant/models/sample_model.mjs`

```javascript
import InstantORM from '@instant.dev/orm';

class SampleModel extends Model {

  static tableName = 'sample_models';

  async beforeSave (txn) {}
  async afterSave (txn) {}
  async beforeDestroy (txn) {}
  async afterDestroy (txn) {}

}

SampleModel.calculates(/* ... */);
SampleModel.validates(/* ... */);
SampleModel.verifies(/* ... */);
SampleModel.hides(/* ... */);

export default SampleModel;
```

The Instant ORM will automatically associate each file with the appropriate
table in your database schema, provided `SampleModel.tableName` matches a table
on your Database. You can access your Models using;

```javascript
// Note that "SampleModels", "samplemodel", "sample_models" etc.
// will all work as well as long as there's no ambiguity
Instant.Model('SampleModel');
```

## Using Models

### CRUD Operations

Write me

### Query composition

Write me!

### Transactions

Write me!!

### Input validation

Write me!!!

### Relationship verification

Write me!!!!

### Calculated fields

Write me!!!!!

### Lifecycle callbacks

Write me!!!!!!

## Using Migrations, Seeding and Code Generation

Migrations, seeds and code generation can be managed via the
[instant.dev](https://github.com/instant-dev/instant) CLI.

## Acknowledgements

Thank you!
